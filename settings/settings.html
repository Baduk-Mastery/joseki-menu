<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Go Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
/* Black reveal overlay (covers settings on load, then fades away) */
#settings-fade{
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 100001; /* above #settings-overlay (100000) */
  opacity: 1;
  transition: opacity .9s ease;
}

/* Triggered by JS */
#settings-fade.is-hidden{
  opacity: 0;
  pointer-events: none;
}

/* Accessibility */
@media (prefers-reduced-motion: reduce){
  #settings-fade{
    transition: none;
  }
}

    /* ========= Overlay chrome (WOOD background) ========= */
    #settings-overlay{
      display:none; /* will be turned to flex via JS on load */
      position:fixed;
      inset:0;
      z-index:100000;
      align-items:flex-start;
      justify-content:center;
      padding:12px 0;
      color:#fff;
      -webkit-tap-highlight-color:transparent;
      --wood:url('../img/wood.jpg');
      background-image:
        linear-gradient(rgba(0,0,0,.35), rgba(0,0,0,.45)),
        var(--wood);
      background-size:cover;
      background-position:center;
      overscroll-behavior:contain;
      isolation:isolate;
      --maxw:720px;
    }

/* Header + card container – width matches board wrapper pattern */
#settings-overlay .s-inner{
  width:100%;
  max-width:var(--maxw);
  padding:16px 24px 22px;
  margin:0 auto;
  position:relative;
  display:grid;
  grid-template-columns:auto 1fr;
  grid-template-rows:auto 1fr;
  grid-template-areas:
    "back  title"
    "card  card";
  align-items:center;
  gap:12px 16px;
  text-align:left;
  box-sizing:border-box;
}


    /* Back button – wood style, same as Drills header back */
    #settings-overlay .s-back{
      grid-area:back;
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;

      padding:6px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.40);

      font-size:14px;
      font-weight:800;
      line-height:1.1;
      color:#fff3cf;
      text-shadow:0 1px 0 rgba(120,60,20,.7);
      cursor:pointer;

      user-select:none;
      -webkit-user-select:none;
      -moz-user-select:none;
      -ms-user-select:none;
      -webkit-tap-highlight-color:transparent;

      background-image:
        linear-gradient(
          to bottom,
          rgba(255,255,255,.12),
          rgba(255,255,255,.03) 38%,
          rgba(0,0,0,.14) 100%
        ),
        var(--wood);
      background-size:100% 100%, cover;
      background-position:center;
      background-repeat:no-repeat;

      filter:brightness(1.08) saturate(.96);

      box-shadow:
        0 3px 0 rgba(133,74,26,.85),
        0 8px 14px rgba(0,0,0,.45);

      transition:
        transform .08s ease-out,
        box-shadow .08s ease-out,
        filter .12s ease-out;

      white-space:nowrap;
      z-index:1;
    }
    #settings-overlay .s-back:hover{
      filter:brightness(1.12) saturate(.98);
      transform:translateY(-1px);
      box-shadow:
        0 4px 0 rgba(133,74,26,.9),
        0 10px 16px rgba(0,0,0,.48);
    }
    #settings-overlay .s-back:active{
      filter:brightness(.97) saturate(.96);
      transform:translateY(2px);
      box-shadow:
        0 1px 0 rgba(120,60,20,.9),
        0 4px 8px rgba(0,0,0,.55);
    }

    #settings-overlay .s-title{
      grid-area:title;
      position:static !important;
      display:block !important;
      margin:0 !important;
      font-size:24px;
      font-weight:800;
      line-height:1.15;
      text-shadow:0 1px 2px rgba(0,0,0,.35);
      overflow:visible;
      min-width:0;
    }

    #settings-overlay .s-card{
      grid-area:card;
      background: rgba(37,99,235,.22);
      border:2px solid rgba(37,99,235,.75);
      border-radius:12px;
      box-shadow:0 8px 20px rgba(2,6,23,.45), inset 0 0 0 1px rgba(255,255,255,.08);
      padding:12px;
      color:#e6f3ff;
      box-sizing:border-box;
    }

    #settings-overlay .s-row{
      display:flex !important;
      align-items:center;
      justify-content:space-between;
      padding:14px 12px;
      border-radius:12px;
    }
    #settings-overlay .s-row + .s-row{
      margin-top:6px;
    }
    #settings-overlay .s-label{
      font-size:18px;
      font-weight:700;
      letter-spacing:.2px;
      color:#e6f3ff;
    }

    /* Subsetting row (child of Zoom) */
    #settings-overlay .s-row-sub{
      padding-left:24px;
      background:rgba(15,23,42,.22);
    }
    #settings-overlay .s-label-sub{
      font-size:15px;
      font-weight:600;
      letter-spacing:.15px;
      opacity:.9;
    }
    #settings-overlay .s-row-sub.is-disabled{
      opacity:.45;
    }
    #settings-overlay .s-row-sub.is-disabled .seg-btn{
      pointer-events:none;
      cursor:default;
      box-shadow:none;
    }
    #settings-overlay .s-row-sub.is-disabled .seg{
      background:#0b1020;
      border-color:#1e2536;
      box-shadow:none;
    }

    #settings-overlay .seg{
      display:inline-flex !important;
      gap:6px;
      padding:4px;
      background:#161b29;
      border:1px solid #2b3246;
      border-radius:999px;
      box-shadow:inset 0 2px 8px rgba(0,0,0,.35);
    }
    #settings-overlay .seg-btn{
      position:static !important;
      min-width:72px;
      padding:10px 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background:transparent;
      color:#cfe2ff;
      font-weight:800;
      font-size:14px;
      letter-spacing:.4px;
      text-transform:uppercase;
      transition:transform .06s;
    }
    #settings-overlay .seg-btn:active{
      transform:translateY(1px);
    }
    #settings-overlay .seg-btn[aria-pressed="true"]{
      background:#3b82f6;
      color:#fff;
      box-shadow:0 6px 18px rgba(59,130,246,.45);
    }

@media (max-width: 360px){
  #settings-overlay .s-inner{
    grid-template-columns: auto 1fr;
    gap:10px 12px;
    padding:16px 12px 20px; /* keep this; now width is handled by max-width */
  }
  #settings-overlay .s-title{
    font-size:22px;
  }
}
/* ===== Settings header centering fix (same row as Back) ===== */
/* Paste at the END of the <style> block to override earlier grid-area layout */

#settings-overlay .s-inner{
  width:100%;
  max-width:var(--maxw);
  padding:16px 24px 22px;
  margin:0 auto;
  position:relative;

  display:grid;
  grid-template-columns:auto 1fr;
  grid-template-rows:auto auto;
  gap:12px 16px;
  align-items:center;
  text-align:left;
  box-sizing:border-box;
}

/* Back stays left in row 1 */
#settings-overlay .s-back{
  grid-area:auto;
  grid-column:1;
  grid-row:1;
  justify-self:start;
}

/* Title is truly centered across the full header width, same row */
#settings-overlay .s-title{
  grid-area:auto;
  grid-column:1 / -1;
  grid-row:1;
  justify-self:center;
  text-align:center;

  /* keep clicks on Back clean */
  pointer-events:none;

  /* safety for long titles */
  max-width:70%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Card goes below, full width */
#settings-overlay .s-card{
  grid-area:auto;
  grid-column:1 / -1;
  grid-row:2;
}

/* Re-apply your small-screen tweaks since this block overrides earlier ones */
@media (max-width: 360px){
  #settings-overlay .s-inner{
    padding:16px 12px 20px;
    gap:10px 12px;
  }
  #settings-overlay .s-title{
    font-size:22px;
  }
}

  </style>
</head>
<body>
  <div id="settings-fade" aria-hidden="true"></div>
<!-- ===== Settings Overlay ===== -->
<div id="settings-overlay" aria-modal="true" role="dialog">
  <div class="s-inner">
    <button id="s-back" class="s-back" type="button" aria-label="Back to menu">← Back</button>
    <h1 class="s-title">Settings</h1>

    <!-- Card -->
    <div class="s-card">
      <!-- Row: Sound -->
      <div class="s-row">
        <div class="s-label">Sound</div>
        <div class="seg" role="group" aria-label="Sound setting">
          <button id="sound-on"  class="seg-btn" data-val="on"  aria-pressed="false">ON</button>
          <button id="sound-off" class="seg-btn" data-val="off" aria-pressed="false">OFF</button>
        </div>
      </div>

      <!-- Row: Highlight last -->
      <div class="s-row">
        <div class="s-label">Highlight last Move</div>
        <div class="seg" role="group" aria-label="Highlight last setting">
          <button id="hlast-on"  class="seg-btn" data-val="on"  aria-pressed="false">ON</button>
          <button id="hlast-off" class="seg-btn" data-val="off" aria-pressed="false">OFF</button>
        </div>
      </div>
      <!-- Row: Auto-play speed -->
      <div class="s-row">
        <div class="s-label">Auto-play speed</div>
        <div class="seg" role="group" aria-label="Auto-play speed setting">
          <button id="speed-fast" class="seg-btn" data-val="fast" aria-pressed="false">FAST</button>
          <button id="speed-slow" class="seg-btn" data-val="slow" aria-pressed="false">SLOW</button>
        </div>
      </div>


      <!-- Row: Zoom -->
      <div class="s-row">
        <div class="s-label">Zoom</div>
        <div class="seg" role="group" aria-label="Zoom setting">
          <button id="zoom-on"  class="seg-btn" data-val="on"  aria-pressed="false">ON</button>
          <button id="zoom-off" class="seg-btn" data-val="off" aria-pressed="false">OFF</button>
        </div>
      </div>

      <!-- Row: Disable auto zoom out (subsetting of Zoom) -->
      <div class="s-row s-row-sub" id="row-azoff">
        <div class="s-label s-label-sub">Disable auto zoom out</div>
        <div class="seg" id="seg-azoff" role="group" aria-label="Disable auto zoom out setting">
          <button id="azoff-on"  class="seg-btn" data-val="on"  aria-pressed="false">ON</button>
          <button id="azoff-off" class="seg-btn" data-val="off" aria-pressed="false">OFF</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  if (window.GoSettings && window.GoSettings.__ready) return;

  var panel = document.getElementById('settings-overlay');
  if (!panel) return;

  var MENU_URL    = '../joseki-menu/index.html';
  var STORAGE_KEY = 'go_prefs';
  var leavingToMenu = false;

  function goBackToMenu(){
    if (leavingToMenu) return;
    leavingToMenu = true;
    // Always go directly to the menu, no history.back → no bfcache flicker
    window.location.replace(MENU_URL);
  }

  // Shared prefs object
  var GoPrefs = (window.GoPrefs = window.GoPrefs || {});

  // Load from localStorage
  try {
    var saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      Object.assign(GoPrefs, JSON.parse(saved) || {});
    }
  } catch (e) {}

  // Defaults
  if (typeof GoPrefs.josekiZoom === 'undefined')           GoPrefs.josekiZoom           = true;
  if (typeof GoPrefs.soundOn === 'undefined')              GoPrefs.soundOn              = true;
  if (typeof GoPrefs.highlightLast === 'undefined')        GoPrefs.highlightLast        = true;
  if (typeof GoPrefs.disableAutoZoomOut === 'undefined')   GoPrefs.disableAutoZoomOut   = false;
  if (typeof GoPrefs.autoPlaySpeed === 'undefined')        GoPrefs.autoPlaySpeed        = 'fast';  // NEW


  // Keep dependent pref consistent on load
  if (!GoPrefs.josekiZoom && GoPrefs.disableAutoZoomOut){
    GoPrefs.disableAutoZoomOut = false;
  }

  function savePrefs(){
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(GoPrefs));
    } catch (e) {}
  }

  function broadcast(key){
    try {
      var ev = new CustomEvent('go:prefs-changed', {
        detail: { key: key, value: GoPrefs[key] }
      });
      window.dispatchEvent(ev);
    } catch (e) {}
  }

  function applyToBoards(){
    // Zoom
    try {
      if (window.JosekiZoom && typeof JosekiZoom.setEnabled === 'function') {
        JosekiZoom.setEnabled(!!GoPrefs.josekiZoom);
      }
      if (window.PracticeZoom && typeof PracticeZoom.setEnabled === 'function') {
        PracticeZoom.setEnabled(!!GoPrefs.josekiZoom);
      }
    } catch (e) {}

    // Sound
    try {
      if (window.JosekiSound && typeof JosekiSound.setEnabled === 'function') {
        JosekiSound.setEnabled(!!GoPrefs.soundOn);
      }
      if (window.PracticeSound && typeof PracticeSound.setEnabled === 'function') {
        PracticeSound.setEnabled(!!GoPrefs.soundOn);
      }
    } catch (e) {}

    // Highlight
    try {
      if (window.JosekiHighlight && typeof JosekiHighlight.setEnabled === 'function') {
        JosekiHighlight.setEnabled(!!GoPrefs.highlightLast);
      }
      if (window.PracticeHighlight && typeof PracticeHighlight.setEnabled === 'function') {
        PracticeHighlight.setEnabled(!!GoPrefs.highlightLast);
      }
    } catch (e) {}
    // NEW: Auto-play speed
    try {
      if (window.JosekiSpeed && typeof JosekiSpeed.setSpeed === 'function') {
        JosekiSpeed.setSpeed(GoPrefs.autoPlaySpeed || 'fast');
      }
      if (window.PracticeSpeed && typeof PracticeSpeed.setSpeed === 'function') {
        PracticeSpeed.setSpeed(GoPrefs.autoPlaySpeed || 'fast');
      }
    } catch (e) {}
  }

  function setPref(key, val){
    GoPrefs[key] = !!val;
    savePrefs();
    broadcast(key);
    applyToBoards();
  }

  // NEW: for string/enum settings (like autoPlaySpeed)
  function setEnumPref(key, val, allowed, fallback){
    var v = val;
    if (!allowed || allowed.indexOf(v) === -1) v = fallback;
    GoPrefs[key] = v;
    savePrefs();
    broadcast(key);
    applyToBoards();
  }

  // UI elements
  var zoomOn   = document.getElementById('zoom-on');
  var zoomOff  = document.getElementById('zoom-off');
  var soundOn  = document.getElementById('sound-on');
  var soundOff = document.getElementById('sound-off');
  var hOn      = document.getElementById('hlast-on');
  var hOff     = document.getElementById('hlast-off');
  var azOn     = document.getElementById('azoff-on');
  var azOff    = document.getElementById('azoff-off');
  var azRow    = document.getElementById('row-azoff');
  var speedFast = document.getElementById('speed-fast');
  var speedSlow = document.getElementById('speed-slow');

  var backBtn  = document.getElementById('s-back');

  function syncButtons(){
    // Zoom first (sub-settings depend on it)
    var zoomOnVal = !!GoPrefs.josekiZoom;

    if (zoomOn && zoomOff){
      zoomOn.setAttribute('aria-pressed', zoomOnVal ? 'true' : 'false');
      zoomOff.setAttribute('aria-pressed', zoomOnVal ? 'false' : 'true');
    }
    if (soundOn && soundOff){
      soundOn.setAttribute('aria-pressed', GoPrefs.soundOn ? 'true' : 'false');
      soundOff.setAttribute('aria-pressed', GoPrefs.soundOn ? 'false' : 'true');
    }
    if (hOn && hOff){
      hOn.setAttribute('aria-pressed', GoPrefs.highlightLast ? 'true' : 'false');
      hOff.setAttribute('aria-pressed', GoPrefs.highlightLast ? 'false' : 'true');
    }
    if (azOn && azOff){
      // If Zoom is OFF, force the subsetting OFF as well
      if (!zoomOnVal && GoPrefs.disableAutoZoomOut){
        GoPrefs.disableAutoZoomOut = false;
        try {
          savePrefs();
          broadcast('disableAutoZoomOut');
        } catch(e){}
      }
      azOn.setAttribute('aria-pressed', GoPrefs.disableAutoZoomOut ? 'true' : 'false');
      azOff.setAttribute('aria-pressed', GoPrefs.disableAutoZoomOut ? 'false' : 'true');
    }

    // NEW: speed buttons
    if (speedFast && speedSlow){
      var isSlow = (GoPrefs.autoPlaySpeed === 'slow');
      speedFast.setAttribute('aria-pressed', isSlow ? 'false' : 'true');
      speedSlow.setAttribute('aria-pressed', isSlow ? 'true' : 'false');
    }

    // Grey out the sub-rows (only Disable auto zoom out now)
    if (azRow){
      // Row depends only on Zoom
      if (zoomOnVal) azRow.classList.remove('is-disabled');
      else           azRow.classList.add('is-disabled');
    }
  }


  // Wire up handlers
  if (zoomOn)  zoomOn.addEventListener('click',  function(){
    setPref('josekiZoom', true);
    syncButtons();
  });
  if (zoomOff) zoomOff.addEventListener('click', function(){
    setPref('josekiZoom', false);
    // sub-settings will be forced OFF and greyed via syncButtons()
    syncButtons();
  });

  if (soundOn)  soundOn.addEventListener('click',  function(){ setPref('soundOn', true);  syncButtons(); });
  if (soundOff) soundOff.addEventListener('click', function(){ setPref('soundOn', false); syncButtons(); });

  if (hOn)  hOn.addEventListener('click',  function(){ setPref('highlightLast', true);  syncButtons(); });
  if (hOff) hOff.addEventListener('click', function(){ setPref('highlightLast', false); syncButtons(); });

  if (speedFast) speedFast.addEventListener('click', function(){
    setEnumPref('autoPlaySpeed', 'fast', ['fast', 'slow'], 'fast');
    syncButtons();
  });
  if (speedSlow) speedSlow.addEventListener('click', function(){
    setEnumPref('autoPlaySpeed', 'slow', ['fast', 'slow'], 'fast');
    syncButtons();
  });
  // Sub-setting: Disable auto zoom out – only active when Zoom is ON
  if (azOn)  azOn.addEventListener('click', function(){
    if (!GoPrefs.josekiZoom) return;
    setPref('disableAutoZoomOut', true);
    syncButtons();
  });
  if (azOff) azOff.addEventListener('click', function(){
    if (!GoPrefs.josekiZoom) return;
    setPref('disableAutoZoomOut', false);
    syncButtons();
  });

  if (backBtn){
    backBtn.addEventListener('click', function(){
      goBackToMenu();
    });
  }


  // Show the overlay and sync UI/state on load
  panel.style.display = 'flex';
  savePrefs(); // persist any normalization we did
  syncButtons();
  applyToBoards();

  window.GoSettings = {
    __ready: true,
    getPrefs: function(){ return Object.assign({}, GoPrefs); },
    setZoom: function(on){ setPref('josekiZoom', !!on); syncButtons(); },
    setSound: function(on){ setPref('soundOn', !!on); syncButtons(); },
    setHighlight: function(on){ setPref('highlightLast', !!on); syncButtons(); }
  };
})();
</script>
<script>
  (function () {
    var fade = document.getElementById("settings-fade");
    if (!fade) return;

    var reduceMotion = window.matchMedia &&
      window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    if (reduceMotion) {
      fade.remove();
      return;
    }

    function runReveal() {
      // snap to black without animating
      fade.style.transition = "none";
      fade.classList.remove("is-hidden");

      // force reflow so the browser applies opacity:1 immediately
      void fade.offsetHeight;

      // hand control back to CSS
      fade.style.transition = "";

      // fade out on next frame
      requestAnimationFrame(function () {
        fade.classList.add("is-hidden");
      });
    }

    // runs on first load AND when returning via back/forward cache
    window.addEventListener("pageshow", runReveal);
  })();
</script>

</body>
</html>





