<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Joseki Master – Drills</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* Base page look, same vibe as other pages */
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #e6f3ff;
      background:
        linear-gradient(rgba(0,0,0,.35), rgba(0,0,0,.55)),
        url("https://3d85c7a311526e02aeeeb19e952d0c09.cdn.bubble.io/f1755870506985x437178801728222500/wood.jpg");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    /* All the original Drills styles, scoped to drills-root */
    #drills-root{
      --wood:url('https://3d85c7a311526e02aeeeb19e952d0c09.cdn.bubble.io/f1755870506985x437178801728222500/wood.jpg');
      --maxw:720px;
      color:#e6f3ff;
    }
    #drills-root #drills-overlay{
      position:fixed; inset:0; z-index:100000; display:none;
      align-items:flex-start; justify-content:center;
      padding:12px 0; overflow:auto; -webkit-overflow-scrolling:touch;
      background-image:
        linear-gradient(rgba(0,0,0,.35), rgba(0,0,0,.45)),
        var(--wood);
      background-size:cover; background-position:center;
    }
    #drills-root .s-inner{
      width:min(92vw,var(--maxw)); padding:16px 24px 22px; text-align:left; margin:0 auto; position:relative;
    }
    #drills-root .s-header{
      display:grid; grid-template-columns:auto 1fr; align-items:center; column-gap:14px; margin:6px 0 10px;
    }
    #drills-root .s-title{ margin:0; font-size:24px; line-height:1.15; font-weight:800; text-shadow:0 1px 2px rgba(0,0,0,.35); }

    #drills-root .s-back,
    #drills-root .s-btn,
    #drills-root .s-card{
      background: rgba(37,99,235,.22);
      color:#e6f3ff;
      border:2px solid rgba(37,99,235,.75);
      border-radius:12px;
      box-shadow:0 8px 20px rgba(2,6,23,.45), inset 0 0 0 1px rgba(255,255,255,.08);
    }
    #drills-root .s-back{
      padding:8px 12px; cursor:pointer; font-weight:800; line-height:1;
      transition:transform .06s, background .15s, box-shadow .15s;
    }
    #drills-root .s-back:hover{  background: rgba(37,99,235,.26); }
    #drills-root .s-back:active{ background: rgba(37,99,235,.32); transform:translateY(1px); }

    #drills-root .s-card{ padding:12px; box-sizing:border-box; overflow:hidden; }
    #drills-root .info-title{ font-weight:900; font-size:16px; margin-bottom:4px; }
    #drills-root .info-desc{ font-size:13px; line-height:1.5; opacity:.96; }

    #drills-root .s-btn{
      display:inline-block; padding:10px 12px; font-weight:800; font-size:13px; cursor:pointer;
      transition:transform .06s, background .15s, box-shadow .15s;
    }
    #drills-root .s-btn.s-btn-lg{ font-size:16px; padding:14px 18px; }
    #drills-root .s-btn:active{ transform:translateY(1px); }

    #drills-root .drill-grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px; }
    @media (min-width: 720px){ #drills-root .drill-grid{ grid-template-columns:1fr 1fr; } }

    #drills-root .drill-card{
      display:flex; align-items:center; gap:12px; width:100%; text-align:left; padding:10px; cursor:pointer;
      transition:transform .06s, background .15s; user-select:none; -webkit-user-select:none;
    }
    #drills-root .drill-card:active{ transform:translateY(1px); }
    #drills-root .drill-meta{ flex:1; min-width:0; }
    #drills-root .drill-title{ font-weight:800; font-size:18px; line-height:1.3; }

    #drills-root .drill-desc, #drills-root .joseki-desc{ display:none !important; }
    #drills-root .drill-cta{ margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; }

    #drills-root .drill-list-grid{
      display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px;
    }
    @media (min-width: 720px){ #drills-root .drill-list-grid{ grid-template-columns:1fr 1fr; } }

    #drills-root .joseki-card{
      position:relative; display:flex; align-items:center; gap:12px; width:100%;
      text-align:left; padding:10px; cursor:pointer;
      transition:transform .06s, background .15s; user-select:none; -webkit-user-select:none;
    }
    #drills-root .joseki-card:active{ transform:translateY(1px); }

    #drills-root .drill-thumb{
      width:132px; height:132px; border-radius:10px; overflow:hidden; flex:none;
      position: relative;
      background-image:
        linear-gradient(rgba(0,0,0,.04), rgba(0,0,0,.06)),
        var(--wood);
      background-size:cover; background-position:center;
      border:2px solid rgba(37,99,235,.65);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    #drills-root .drill-thumb canvas.prac-canvas{
      position:absolute; inset:0; width:100%; height:100%;
      display:block; pointer-events:none;
    }

    #drills-root .joseki-meta{ flex:1; min-width:0; display:flex; flex-direction:column; }
    #drills-root .joseki-title{ font-weight:800; font-size:18px; line-height:1.3; }

    #drills-root .tickbox{
      position:absolute; top:10px; right:10px; width:24px; height:24px; border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      border:2px solid rgba(37,99,235,.75); background: rgba(37,99,235,.18);
      font-weight:900; font-size:16px; line-height:1;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); user-select:none;
    }
    #drills-root .tickbox::after{ content:""; }
    #drills-root .tickbox[aria-checked="true"]{ background: rgba(37,99,235,.35); border-color:#60a5fa; }
    #drills-root .tickbox[aria-checked="true"]::after{ content:"✓"; }

    #drills-root .drill-actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px; justify-content:flex-start; padding:8px 0;
    }
    #drills-root .drill-count{ margin-left:auto; opacity:.95; font-size:13px; }

    #drills-root .floating-clear{
      position:fixed;
      left:calc(env(safe-area-inset-left, 0px) + 12px);
      bottom:calc(env(safe-area-inset-bottom, 0px) + 28px);
      z-index:100003;
    }
    @media (max-width:480px){
      #drills-root .floating-clear{
        left:calc(env(safe-area-inset-left, 0px) + 8px);
        bottom:calc(env(safe-area-inset-bottom, 0px) + 20px);
      }
    }

    #drills-root .floating-start{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom, 0px) + 28px);
      transform:translate(-50%, 0);
      z-index:100010;
      display:none;
      white-space:nowrap;
      pointer-events:auto;
      touch-action:manipulation;
    }
    #drills-root .floating-start:active{ transform:translate(-50%, 0); }
    @media (max-width:480px){
      #drills-root .floating-start{
        bottom:calc(env(safe-area-inset-bottom, 0px) + 20px);
      }
    }

    #drills-root #drills-notice{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      z-index:100001; display:none; padding:0; background:transparent;
      pointer-events:none;
    }
    #drills-root #drills-notice .s-inner{ width:auto; padding:0; margin:0; display:block; }
    #drills-root #drills-notice .drills-notice-card{
      pointer-events:auto;
      background:none;
      background-image:
        linear-gradient(rgba(0,0,0,.35), rgba(0,0,0,.45)),
        var(--wood);
      background-size:cover; background-position:center;
      border:2px solid rgba(37,99,235,.75);
      border-radius:12px;
      box-shadow:0 8px 20px rgba(2,6,23,.45), inset 0 0 0 1px rgba(255,255,255,.08);
      min-width:280px; max-width:min(92vw, 420px);
      max-height:calc(100vh - 32px); overflow:auto;
      text-shadow:0 1px 2px rgba(0,0,0,.35);
      padding:10px 12px;
    }
    #drills-root #drills-notice .actions{
      margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    }

    #drills-root.notice-open #drills-overlay .s-inner{ pointer-events:none; }

    @media (max-width:480px){
      #drills-root .s-inner{ padding:16px 12px 22px; }
    }

    #drills-root #drills-mode-view .drill-meta{
      display:flex; align-items:center; gap:12px;
    }
    #drills-root #drills-mode-view .drill-cta{
      margin-top:0; margin-left:auto;
    }
  </style>
</head>
<body>

<div id="drills-root">
  <!-- Drills overlay -->
  <div id="drills-overlay" aria-modal="true" role="dialog" style="display:none">
    <div class="s-inner">
      <div class="s-header">
        <button id="drills-back" class="s-back" type="button" aria-label="Back">← Back</button>
        <h1 class="s-title">Drills</h1>
      </div>

      <!-- Mode chooser -->
      <div id="drills-mode-view" style="display:none">
        <div class="s-card info" style="margin-top:6px">
          <div class="info-title">Choose a mode</div>
          <div class="info-desc">Pick how you want to practice.</div>
        </div>
        <div class="drill-grid" id="drills-mode-grid">
          <button class="s-card drill-card" data-mode="complete" type="button" aria-label="Complete mode">
            <div class="drill-meta">
              <div class="drill-title">Complete</div>
              <div class="drill-cta"><span class="s-btn">Choose</span></div>
            </div>
          </button>

          <button class="s-card drill-card" data-mode="blitz" type="button" aria-label="Blitz mode">
            <div class="drill-meta">
              <div class="drill-title">Blitz</div>
              <div class="drill-cta"><span class="s-btn">Choose</span></div>
            </div>
          </button>
        </div>
      </div>

      <!-- Intro card -->
      <div class="s-card info" id="drills-intro">
        <div class="info-title">How Complete drills work</div>
        <div class="info-desc">
          Complete drills drop you into a random point of each selected joseki/pattern (10+ moves only).
          Three drills per joseki, with random corner and color. Your task: finish the sequence correctly.
        </div>
      </div>

      <!-- Options -->
      <div class="drill-grid" id="drills-options">
        <button class="s-card drill-card" data-type="library" type="button" aria-label="Drills from Library Josekis">
          <div class="drill-meta">
            <div class="drill-title">From Library Josekis</div>
            <div class="drill-cta"><span class="s-btn">Choose</span></div>
          </div>
        </button>

        <button class="s-card drill-card" data-type="favorites" type="button" aria-label="Drills from Favorites">
          <div class="drill-meta">
            <div class="drill-title">From Favorites</div>
            <div class="drill-cta"><span class="s-btn">Choose</span></div>
          </div>
        </button>

        <button class="s-card drill-card" data-type="own" type="button" aria-label="Drills from My Patterns">
          <div class="drill-meta">
            <div class="drill-title">From My Patterns</div>
            <div class="drill-cta"><span class="s-btn">Choose</span></div>
          </div>
        </button>
      </div>

      <!-- Library -->
      <div id="drills-lib-view" style="display:none">
        <div class="s-card info" id="drill-lib-info" style="margin-top:6px">
          <div class="info-title">Select a category</div>
          <div class="info-desc">Grouped by the first two moves. Tap a category to pick josekis (10+ moves).</div>
        </div>
        <div class="drill-list-grid" id="drill-lib-grid"></div>
        <div class="drill-actions">
          <button class="s-btn floating-clear" id="drill-lib-clear"  type="button">Clear</button>
          <div class="drill-count" id="drill-lib-count" aria-live="polite">0 selected</div>
        </div>
      </div>

      <!-- Favorites -->
      <div id="drills-fav-view" style="display:none">
        <div class="s-card info" style="margin-top:6px">
          <div class="info-title">Select favorite josekis</div>
          <div class="info-desc">Tap cards to toggle ✓. Shows your starred josekis (10+ moves).</div>
        </div>
        <div class="drill-list-grid" id="drill-fav-grid"></div>
        <div class="drill-actions">
          <button class="s-btn floating-clear" id="drill-fav-clear"  type="button">Clear</button>
          <div class="drill-count" id="drill-fav-count" aria-live="polite">0 selected</div>
        </div>
      </div>

      <!-- Own patterns -->
      <div id="drills-own-view" style="display:none">
        <div class="s-card info" style="margin-top:6px">
          <div class="info-title">Select your patterns</div>
          <div class="info-desc">Tap cards to toggle ✓. Only patterns with 10+ moves are listed.</div>
        </div>
        <div class="drill-list-grid" id="drill-own-grid"></div>
        <div class="drill-actions">
          <button class="s-btn floating-clear" id="drill-own-clear"  type="button">Clear</button>
          <div class="drill-count" id="drill-own-count" aria-live="polite">0 selected</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Centered notice -->
  <div id="drills-notice" role="alert" aria-live="polite" style="display:none">
    <div class="s-inner">
      <div class="s-card drills-notice-card">
        <div class="info-title" id="drills-notice-title">Heads up</div>
        <div class="info-desc" id="drills-notice-text">You can add a maximum of 10 patterns.</div>
        <div class="actions" style="margin-top:12px;">
          <button id="drills-notice-ok" class="s-btn s-btn-lg" type="button" aria-label="Close">OK</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  var root   = document.getElementById('drills-root');
  if (!root) return;

  var overlay   = root.querySelector('#drills-overlay');
  var backBtn   = root.querySelector('#drills-back');
  var titleEl   = root.querySelector('.s-title');
  var introCard = root.querySelector('#drills-intro');

  var modeView  = root.querySelector('#drills-mode-view');
  var modeGrid  = root.querySelector('#drills-mode-grid');
  var options   = root.querySelector('#drills-options');

  var libView   = root.querySelector('#drills-lib-view');
  var libInfo   = libView.querySelector('#drill-lib-info');
  var libInfoTitle = libInfo.querySelector('.info-title');
  var libInfoDesc  = libInfo.querySelector('.info-desc');

  var libCatsGrid = libView.querySelector('#drill-lib-grid');
  var libVarsGrid = document.createElement('div');
  libVarsGrid.id = 'drill-lib-vars';
  libVarsGrid.className = 'drill-list-grid';
  libVarsGrid.style.display = 'none';
  libView.insertBefore(libVarsGrid, libView.querySelector('.drill-actions'));

  var libClear  = root.querySelector('#drill-lib-clear');
  var libCount  = root.querySelector('#drill-lib-count');

  var favView   = root.querySelector('#drills-fav-view');
  var favGrid   = root.querySelector('#drill-fav-grid');
  var favClear  = root.querySelector('#drill-fav-clear');
  var favCount  = root.querySelector('#drill-fav-count');

  var ownView   = root.querySelector('#drills-own-view');
  var ownGrid   = root.querySelector('#drill-own-grid');
  var ownClear  = root.querySelector('#drill-own-clear');
  var ownCount  = root.querySelector('#drill-own-count');

  var startBtn = document.createElement('button');
  startBtn.id = 'drills-start';
  startBtn.type = 'button';
  startBtn.className = 's-btn s-btn-lg floating-start';
  startBtn.textContent = 'Start Drill';
  startBtn.setAttribute('aria-label','Start Drill');
  startBtn.style.display = 'none';
  root.appendChild(startBtn);

  ['pointerdown','pointerup','mousedown','mouseup','touchstart','touchend','click'].forEach(function(type){
    startBtn.addEventListener(type, function(e){
      e.stopPropagation();
      if (type !== 'click') e.preventDefault();
    }, true);
  });

  startBtn.addEventListener('click', function(e){
    e.stopPropagation();
    showNotice('Drill board coming soon.', 'Start Drill');
  });

  var notice     = root.querySelector('#drills-notice');
  var noticeText = root.querySelector('#drills-notice-text');
  var noticeOk   = root.querySelector('#drills-notice-ok');
  function showNotice(msg, title){
    if (noticeText) noticeText.textContent = msg || ('You can add a maximum of ' + MAX_TOTAL + ' patterns.');
    var t = root.querySelector('#drills-notice-title');
    if (t) t.textContent = title || 'Heads up';
    notice.style.display = 'block';
    root.classList.add('notice-open');
    setTimeout(function(){ try { noticeOk && noticeOk.focus(); } catch(_){} }, 30);
  }
  function hideNotice(){ notice.style.display='none'; root.classList.remove('notice-open'); }
  noticeOk && noticeOk.addEventListener('click', hideNotice);
  window.addEventListener('keydown', function(e){ if (e.key==='Escape' && root.classList.contains('notice-open')) hideNotice(); });

  var state = {
    mode:'complete',
    view:'mode',
    builtLib:false, linesLib:[], libCats:[], currentCatKey:null, selectedLib:new Set(),
    builtFav:false, linesFav:[], selectedFav:new Set(),
    builtOwn:false, linesOwn:[], selectedOwnIds:new Set(),
    keyToOwnIds:new Map(),
    ownIdToKey:new Map()
  };

  var LIB_SEL_KEY, FAV_SEL_KEY, OWN_SEL_KEY;

  function loadSelection(key){ try { return new Set(JSON.parse(localStorage.getItem(key) || '[]')); } catch(_){ return new Set(); } }
  function saveSelection(key, set){ try { localStorage.setItem(key, JSON.stringify(Array.from(set))); } catch(_){ } }
  function reloadAllSelections(){
    state.selectedLib    = loadSelection(LIB_SEL_KEY);
    state.selectedFav    = loadSelection(FAV_SEL_KEY);
    state.selectedOwnIds = loadSelection(OWN_SEL_KEY);
  }

  var Tier = window.Tier || {
    get: function(){ try { return (localStorage.getItem('go_tier') || 'free').toLowerCase(); } catch(_) { return 'free'; } }
  };
  function isPro(){
    try{
      if (window.GoLimits && typeof window.GoLimits.get === 'function'){
        var lim = window.GoLimits.get();
        if (lim && lim.drills && lim.drills.triesPerDay === Number.POSITIVE_INFINITY) return true;
      }
    }catch(_){}
    return (Tier.get() || 'free').toLowerCase() === 'pro';
  }

  var MAX_TOTAL = 10;
  function setLimitFromPlan(){
    if (state.mode === 'blitz'){
      MAX_TOTAL = 1;
    } else {
      try{
        if (window.GoLimits && typeof window.GoLimits.get === 'function'){
          var lim = window.GoLimits.get();
          if (lim && lim.drills && typeof lim.drills.maxSelections === 'number'){
            MAX_TOTAL = lim.drills.maxSelections;
          } else {
            MAX_TOTAL = isPro() ? 10 : 2;
          }
        } else {
          MAX_TOTAL = isPro() ? 10 : 2;
        }
      }catch(_){
        MAX_TOTAL = isPro() ? 10 : 2;
      }
    }
    updateLibCount(); updateFavCount(); updateOwnCount(); updateStartButton();
    if (noticeText) noticeText.textContent = 'You can add a maximum of ' + MAX_TOTAL + ' patterns.';
  }

  var overlayOpen = false;

  function showMode(){
    state.view='mode';
    titleEl.textContent='Drills';
    modeView.style.display='block';
    introCard.style.display='none';
    options.style.display='none';
    libView.style.display='none';
    favView.style.display='none';
    ownView.style.display='none';
    startBtn.style.display = 'none';
    startBtn.setAttribute('aria-hidden','true');
    startBtn.disabled = true;
    updateStartButton();
  }

  function open(){
    if (!overlay) return;
    setLimitFromPlan();
    reloadAllSelections();
    overlay.style.display='flex';
    overlayOpen = true;
    showMode();
    if (noticeText) noticeText.textContent = 'You can add a maximum of ' + MAX_TOTAL + ' patterns.';
  }

  // changed for standalone page: closing = go back to main menu
  function close(){
    window.location.href = '../index.html';
  }

  window.GoDrills = {
    open, close, __ready:true,
    getLibrarySelection(){ return Array.from(state.selectedLib); },
    getFavoriteSelection(){ return Array.from(state.selectedFav); },
    getOwnSelection(){ return Array.from(state.selectedOwnIds); },
    getSelections(){
      return {
        library:Array.from(state.selectedLib),
        favorites:Array.from(state.selectedFav),
        own:Array.from(state.selectedOwnIds),
        mode: state.mode
      };
    }
  };

  function setMode(newMode){
    state.mode = (newMode === 'blitz') ? 'blitz' : 'complete';

    if (state.mode === 'blitz'){
      LIB_SEL_KEY = 'drills_blitz_lib_selection';
      FAV_SEL_KEY = 'drills_blitz_fav_selection';
      OWN_SEL_KEY = 'drills_blitz_own_selection_ids';
      MAX_TOTAL = 1;
      var t = introCard.querySelector('.info-title');
      var d = introCard.querySelector('.info-desc');
      if (t) t.textContent = 'How Blitz drills work';
      if (d) d.textContent = 'Pick exactly one joseki/pattern (10+ moves). Quick-fire training. (Start coming soon.)';
      startBtn.textContent = 'Start Blitz';
    } else {
      LIB_SEL_KEY = 'drills_lib_selection';
      FAV_SEL_KEY = 'drills_fav_selection';
      OWN_SEL_KEY = 'drills_own_selection_ids';
      setLimitFromPlan();
      var t2 = introCard.querySelector('.info-title');
      var d2 = introCard.querySelector('.info-desc');
      if (t2) t2.textContent = 'How Complete drills work';
      if (d2) d2.textContent = 'Complete drills drop you into a random point of each selected joseki/pattern (10+ moves only). Three drills per joseki, with random corner and color. Your task: finish the sequence correctly.';
      startBtn.textContent = 'Start Drill';
    }
    reloadAllSelections();
    updateLibCount(); updateFavCount(); updateOwnCount(); updateStartButton();
    if (noticeText) noticeText.textContent = 'You can add a maximum of ' + MAX_TOTAL + ' patterns.';
  }

  function showOptions(whichMode){
    setMode(whichMode || 'complete');
    state.view='options';
    titleEl.textContent='Drills';
    modeView.style.display='none';
    introCard.style.display='';
    options.style.display='grid';
    libView.style.display='none';
    favView.style.display='none';
    ownView.style.display='none';
    updateStartButton();
  }
  function showLib(){
    reloadAllSelections();
    state.view='libCats';
    titleEl.textContent='Choose a Category';
    modeView.style.display='none';
    introCard.style.display='none';
    options.style.display='none';
    favView.style.display='none';
    ownView.style.display='none';
    libView.style.display='block';

    libInfoTitle.textContent = 'Select a category';
    libInfoDesc.textContent  = 'Grouped by the first two moves. Tap a category to pick josekis (10+ moves).';

    if (!state.builtLib){ buildLibraryList(); }
    else { renderLibCategories(); }
    updateLibCount();
  }
  function showLibCategory(catKey){
    state.view='libVars';
    state.currentCatKey = catKey;
    titleEl.textContent='Select Josekis';

    libInfoTitle.textContent = 'Select josekis in this category';
    libInfoDesc.textContent  = 'Tap cards to toggle ✓. Only josekis with 10+ moves are listed.';

    libCatsGrid.style.display='none';
    libVarsGrid.style.display='grid';
    renderLibVariations(catKey);
  }

  function showFav(){
    reloadAllSelections();
    state.view='fav';
    titleEl.textContent='Select Favorites';
    modeView.style.display='none';
    introCard.style.display='none';
    options.style.display='none';
    libView.style.display='none';
    ownView.style.display='none';
    favView.style.display='block';
    buildFavoritesList();
  }
  function showOwn(){
    reloadAllSelections();
    state.view='own';
    titleEl.textContent='Select My Patterns';
    modeView.style.display='none';
    introCard.style.display='none';
    options.style.display='none';
    libView.style.display='none';
    favView.style.display='none';
    ownView.style.display='block';
    buildOwnList();
  }

  // back button: within drills, navigate states; from top level, go back to menu
  backBtn && backBtn.addEventListener('click', function(){
    if (state.view === 'libVars'){
      state.currentCatKey = null;
      titleEl.textContent='Choose a Category';
      libInfoTitle.textContent = 'Select a category';
      libInfoDesc.textContent  = 'Grouped by the first two moves. Tap a category to pick josekis (10+ moves).';
      libVarsGrid.style.display='none';
      libCatsGrid.style.display='grid';
      state.view='libCats';
      return;
    }
    if (state.view === 'libCats' || state.view === 'fav' || state.view === 'own'){
      showOptions(state.mode); return;
    }
    if (state.view === 'options'){
      showMode(); return;
    }
    // from mode or any fallback: leave page
    close();
  });

  modeGrid && modeGrid.addEventListener('click', function(e){
    var card = e.target.closest('.drill-card');
    if (!card) return;
    var mode = card.getAttribute('data-mode');
    if (mode === 'complete'){ showOptions('complete'); }
    else if (mode === 'blitz'){ showOptions('blitz'); }
  });

  options.addEventListener('click', function(e){
    var card = e.target.closest('.drill-card');
    if (!card) return;
    var type = card.getAttribute('data-type');
    if (type === 'library'){ showLib(); }
    else if (type === 'favorites'){ showFav(); }
    else if (type === 'own'){ showOwn(); }
  });

  var SGF_URL = "https://3d85c7a311526e02aeeeb19e952d0c09.cdn.bubble.io/f1756283064420x481184906507390100/game%20%281%29.sgf";
  var MIN_MOVES = 10;

  function rb(str,i){ let out='',k=i; while(k<str.length){ const ch=str[k++]; if(ch==='\\'){ if(k<str.length) out+=str[k++]; continue; } if(ch===']') break; out+=ch; } return {t:out,n:k}; }
  function parseTree(str,i){
    const seq=[]; let node=null; if(str[i]!=='(') return {seq:[],n:i}; i++;
    while(i<str.length){
      const ch=str[i];
      if(ch===';'){ node={}; seq.push(node); i++; }
      else if(/[A-Za-z]/.test(ch)){
        let key=''; while(/[A-Za-z]/.test(str[i]||'')) key+=str[i++]; const vals=[];
        while(str[i]==='['){ const r=rb(str,i+1); vals.push(r.t); i=r.n; }
        if(!node){ node={}; seq.push(node); } node[key]=vals.length>1?vals:vals[0];
      } else if(ch==='('){ const child=parseTree(str,i); i=child.n; if(seq.length){ const p=seq[seq.length-1]; (p.variations||(p.variations=[])).push(child.seq); } }
      else if(ch===')'){ i++; break; } else i++;
    }
    for(let k=0;k<seq.length-1;k++) seq[k].next=seq[k+1];
    return {seq,n:i};
  }
  function parseAllTrees(str){
    const trees=[]; let i=str.indexOf('(');
    if (str.charCodeAt && str.charCodeAt(0)===0xFEFF) str = str.slice(1);
    while(i>=0 && i<str.length){
      const r = parseTree(str,i);
      if (r.seq && r.seq.length) trees.push(r.seq);
      const nxt = str.indexOf('(', r.n);
      if (nxt === -1) break;
      i = nxt;
    }
    return trees;
  }
  function parseSZ(sz){ if(!sz) return 19; if(typeof sz==='string'){ const n=parseInt(sz.split(':')[0],10); return (n>=2&&n<=52)?n:19; } return 19; }
  function xy(s,S){ if(!s||s.length<2) return null; const x=s.charCodeAt(0)-97,y=s.charCodeAt(1)-97; if(x<0||y<0||x>=S||y>=S) return null; return {x,y}; }
  function nodeMove(n,S){ if(!n) return null; if(n.B){ const p=xy(n.B,S); if(p) return {x:p.x,y:p.y,color:'B'}; } if(n.W){ const p=xy(n.W,S); if(p) return {x:p.x,y:p.y,color:'W'}; } return null; }
  function listCoords(prop,S){ const arr=Array.isArray(prop)?prop:(prop?[prop]:[]); const out=[]; for(const v of arr){ const p=xy(v,S); if(p) out.push(p); } return out; }
  function linkify(seq,parent){ for(let i=0;i<seq.length;i++){ const n=seq[i]; n.prev=(i===0?parent:seq[i-1]); n.next=(i<seq.length-1?seq[i+1]:null); if(n.variations) for(const v of n.variations) if(v&&v.length) linkify(v,n); } }
  function enumerateLines(seq,S){
    const lines=[]; let start=seq&&seq[0]; while(start && !nodeMove(start,S) && !start.variations) start=start.next;
    function dfs(node,acc){ if(!node){ lines.push(acc.slice()); return; }
      acc.push(node);
      if(node.variations && node.variations.length){
        for(const v of node.variations){
          let f=v&&v[0]; while(f && !nodeMove(f,S) && !f.variations) f=f.next;
          if(f) dfs(f,acc.slice());
        }
      }
      if(node.next){ let nx=node.next; while(nx && !nodeMove(nx,S) && !nx.variations) nx=nx.next;
        if(nx) dfs(nx,acc); else lines.push(acc.slice()); }
      else lines.push(acc.slice());
    }
    if(start) dfs(start,[]); 
    return lines.map(nodes=>nodes.map(n=>nodeMove(n,S)).filter(Boolean));
  }
  function lineKey(line){
    const size = line.size || 19;
    const seq = (line.moves||[]).map(m => (m.color||'B')[0]+':'+m.x+','+m.y).join('|');
    return size + '|' + seq;
  }

  function hoshiPoints(size){
    if (size === 19) return [3,9,15];
    if (size === 13) return [3,6,9];
    if (size === 9)  return [2,4,6];
    const mid = Math.floor((size-1)/2);
    const off = size >= 15 ? 3 : Math.max(2, Math.round(size/6));
    return [off, mid, size-1-off];
  }
  function ensureCanvas(el){
    var cv = el.querySelector('canvas.prac-canvas');
    if (!cv){
      cv = document.createElement('canvas');
      cv.className = 'prac-canvas';
      el.appendChild(cv);
    }
    return cv;
  }
  function drawStone(ctx, cx, cy, r, color){
    var isBlack = (color === 'B');
    ctx.save();
    ctx.shadowColor = 'transparent';
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.clip();
    var hx = cx - r*0.28, hy = cy - r*0.28;
    var body = ctx.createRadialGradient(hx, hy, r*0.12, cx, cy, r);
    if (isBlack){ body.addColorStop(0.00, '#686868'); body.addColorStop(0.65, '#141414'); body.addColorStop(1.00, '#000'); }
    else { body.addColorStop(0.00, '#fff'); body.addColorStop(0.70, '#f2f2f2'); body.addColorStop(1.00, '#e4e4e4'); }
    ctx.fillStyle = body; ctx.fillRect(cx-r, cy-r, 2*r, 2*r);
    var edge = Math.max(0.6, r*0.08);
    var rim = ctx.createRadialGradient(cx, cy, r-edge, cx, cy, r);
    if (isBlack){ rim.addColorStop(0,'rgba(255,255,255,0)'); rim.addColorStop(1,'rgba(255,255,255,0.12)'); }
    else { rim.addColorStop(0,'rgba(0,0,0,0)'); rim.addColorStop(1,'rgba(0,0,0,0.18)'); }
    ctx.fillStyle = rim; ctx.fillRect(cx-r, cy-r, 2*r, 2*r);
    var spec = ctx.createRadialGradient(hx, hy, 0, hx, hy, r*0.55);
    if (isBlack){ spec.addColorStop(0,'rgba(255,255,255,0.10)'); spec.addColorStop(1,'rgba(255,255,255,0)'); }
    else { spec.addColorStop(0,'rgba(255,255,255,0.22)'); spec.addColorStop(1,'rgba(255,255,255,0)'); }
    ctx.fillStyle = spec; ctx.fillRect(cx-r, cy-r, 2*r, 2*r);
    ctx.restore();
  }
  function simulatePosition(size, rootAB, rootAW, moves){
    var N = size || 19, E=0, B=1, W=2;
    var board = Array.from({length:N}, ()=>Array(N).fill(E));
    function inB(x,y){ return x>=0&&y>=0&&x<N&&y<N; }
    function at(x,y){ return board[y][x]; }
    function set(x,y,v){ board[y][x]=v; }
    function neigh(x,y){ return [[x+1,y],[x-1,y],[x,y+1],[x,y-1]].filter(p=>inB(p[0],p[1])); }
    (Array.isArray(rootAB)?rootAB:[]).forEach(p=>{ if(inB(p.x,p.y)) set(p.x,p.y,B); });
    (Array.isArray(rootAW)?rootAW:[]).forEach(p=>{ if(inB(p.x,p.y)) set(p.x,p.y,W); });
    function groupAndLibs(x,y){
      var c=at(x,y); if(c===E) return null;
      var q=[[x,y]], seen=new Set([x+'_'+y]), group=[[x,y]], libs=0;
      while(q.length){
        var t=q.pop(), cx=t[0], cy=t[1];
        for (const n of neigh(cx,cy)){
          var nx=n[0], ny=n[1], v=at(nx,ny);
          if (v===E){ libs++; continue; }
          if (v===c){
            var k=nx+'_'+ny; if(!seen.has(k)){ seen.add(k); q.push([nx,ny]); group.push([nx,ny]); }
          }
        }
      }
      return {group, libs};
    }
    function removeGroup(g){ for (const p of g) set(p[0],p[1],E); }
    function play(m){
      if(!m) return; var x=m.x,y=m.y; if(!inB(x,y)||at(x,y)!==E) return;
      var c=m.color==='W'?W:B, o=c===B?W:B; set(x,y,c);
      var oppN=[]; for (const n of neigh(x,y)) if(at(n[0],n[1])===o) oppN.push(n);
      var captured=0;
      for (const n of oppN){ var info=groupAndLibs(n[0],n[1]); if(info && info.libs===0){ removeGroup(info.group); captured+=info.group.length; } }
      var mine=groupAndLibs(x,y); if(mine && mine.libs===0 && captured===0) removeGroup(mine.group);
    }
    (Array.isArray(moves)?moves:[]).forEach(play);
    var out=[]; for (var yy=0; yy<N; yy++) for (var xx=0; xx<N; xx++){
      var v=board[yy][xx]; if(v===B) out.push({x:xx,y:yy,color:'B'}); else if(v===W) out.push({x:xx,y:yy,color:'W'});
    }
    return out;
  }
  function drawBoardThumb(el, size, stones, opts){
    var crop = !!(opts && opts.crop);
    var w = Math.max(64, Math.floor(el.clientWidth || 132));
    var h = w, dpr = Math.max(1, window.devicePixelRatio || 1);
    var cv = ensureCanvas(el);
    if (cv.width !== w*dpr || cv.height !== h*dpr){
      cv.width = Math.floor(w*dpr); cv.height = Math.floor(h*dpr);
      cv.style.width = w+'px'; cv.style.height = h+'px';
    }
    var ctx = cv.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);

    var pad = Math.round(w*0.10);
    var inner = w - pad*2;
    var step  = inner / (size - 1);
    var getX  = i => pad + i*step;
    var getY  = j => pad + j*step;

    var minX=0,minY=0,maxX=size-1,maxY=size-1;
    if (crop && stones && stones.length){
      minX=maxX=stones[0].x; minY=maxY=stones[0].y;
      for (const s of stones){ if(s.x<minX)minX=s.x; if(s.x>maxX)maxX=s.x; if(s.y<minY)minY=s.y; if(s.y>maxY)maxY=s.y; }
      var MARGIN=1;
      minX=Math.max(0,minX-MARGIN); minY=Math.max(0,minY-MARGIN);
      maxX=Math.min(size-1,maxX+MARGIN); maxY=Math.min(size-1,maxY+MARGIN);
      var EDGE_NEAR=6;
      var pinLeft=(minX<=EDGE_NEAR), pinTop=(minY<=EDGE_NEAR), pinRight=(maxX>=size-1-EDGE_NEAR), pinBottom=(maxY>=size-1-EDGE_NEAR);
      if(pinLeft)minX=0; if(pinTop)minY=0; if(pinRight)maxX=size-1; if(pinBottom)maxY=size-1;
      var wG=(maxX-minX+1), hG=(maxY-minY+1), target=Math.max(wG,hG);
      if (hG<target){
        var need=target-hG;
        if (pinTop && !pinBottom) maxY=Math.min(size-1,maxY+need);
        else if (pinBottom && !pinTop) minY=Math.max(0,minY-need);
        else { var up=Math.ceil(need/2), dn=Math.floor(need/2); minY=Math.max(0,minY-up); maxY=Math.min(size-1,maxY+dn); }
      }
      if (wG<target){
        var need2=target-wG;
        if (pinLeft && !pinRight) maxX=Math.min(size-1,maxX+need2);
        else if (pinRight && !pinLeft) minX=Math.max(0,minX-need2);
        else { var lf=Math.ceil(need2/2), rt=Math.floor(need2/2); minX=Math.max(0,minX-lf); maxX=Math.min(size-1,maxX+rt); }
      }
    }

    var leftPx  = getX(minX) - step/2;
    var rightPx = getX(maxX) + step/2;
    var topPx   = getY(minY) - step/2;
    var botPx   = getY(maxY) + step/2;
    var cropSide= Math.max(rightPx-leftPx, botPx-topPx);
    var scale   = w / cropSide;

    ctx.save();
    ctx.scale(scale, scale);
    ctx.translate(-leftPx, -topPx);

    ctx.strokeStyle = 'rgba(0,0,0,.9)';
    var desiredPx = Math.max(1, Math.floor(w * 0.006));
    ctx.lineWidth = desiredPx / scale;

    for (var i=0;i<size;i++){
      var y = getY(i);
      ctx.beginPath(); ctx.moveTo(getX(0), y); ctx.lineTo(getX(size-1), y); ctx.stroke();
      var x = getX(i);
      ctx.beginPath(); ctx.moveTo(x, getY(0)); ctx.lineTo(x, getY(size-1)); ctx.stroke();
    }

    ctx.fillStyle = '#000';
    var hs = hoshiPoints(size);
    var hr = Math.max(1, step*0.02);
    for (const ix of hs){
      for (const iy of hs){
        var cx = getX(ix), cy = getY(iy);
        ctx.beginPath(); ctx.arc(cx, cy, hr, 0, Math.PI*2); ctx.fill();
      }
    }

    var r = step * 0.46;
    for (const s of (stones||[])){
      drawStone(ctx, getX(s.x), getY(s.y), r, (s.color==='W'?'W':'B'));
    }
    ctx.restore();
  }
  function renderTwoMoveThumb(el, size, firstTwo){
    var stones=[];
    if (firstTwo[0]) stones.push({x:firstTwo[0].x, y:firstTwo[0].y, color:firstTwo[0].color||'B'});
    if (firstTwo[1]) stones.push({x:firstTwo[1].x, y:firstTwo[1].y, color:firstTwo[1].color||'W'});
    drawBoardThumb(el, size||19, stones, { crop:true });
  }
  function renderVariationThumb(el, line){
    var size = line.size || 19;
    var stones = simulatePosition(size, line.rootAB, line.rootAW, line.moves);
    drawBoardThumb(el, size, stones, { crop:true });
  }

  function totalSelectedCount(){
    var uniqueKeys = new Set([...state.selectedLib, ...state.selectedFav]);
    return uniqueKeys.size + state.selectedOwnIds.size;
  }

  function escAttr(v){ return String(v).replace(/"/g,'\\"'); }
  function isOnLineKey(key){ return state.selectedLib.has(key) || state.selectedFav.has(key); }
  function setTickForLineKey(key){
    var on = isOnLineKey(key) ? 'true' : 'false';
    root.querySelectorAll('.joseki-card[data-key="'+escAttr(key)+'"] .tickbox').forEach(function(t){ t.setAttribute('aria-checked', on); });
  }
  function setTickForOwnId(id){
    var on = state.selectedOwnIds.has(id) ? 'true' : 'false';
    root.querySelectorAll('.joseki-card[data-own-id="'+escAttr(id)+'"] .tickbox').forEach(function(t){ t.setAttribute('aria-checked', on); });
  }

  function maybeAutoReplaceIfBlitz(){
    if (state.mode !== 'blitz') return false;
    if (totalSelectedCount() >= 1){
      clearAllSelections();
      return true;
    }
    return false;
  }

  function deselectLineKeyGlobal(key){
    state.selectedLib.delete(key);
    state.selectedFav.delete(key);
    saveSelection(LIB_SEL_KEY, state.selectedLib);
    saveSelection(FAV_SEL_KEY, state.selectedFav);
    setTickForLineKey(key);
    updateLibCount(); updateFavCount(); updateOwnCount();
  }
  function selectLineKeyIn(source, key){
    if (state.mode === 'blitz') { maybeAutoReplaceIfBlitz(); }
    if (state.selectedLib.has(key) || state.selectedFav.has(key) || totalSelectedCount() < MAX_TOTAL){
      if (source === 'lib'){ state.selectedLib.add(key); saveSelection(LIB_SEL_KEY, state.selectedLib); }
      if (source === 'fav'){ state.selectedFav.add(key); saveSelection(FAV_SEL_KEY, state.selectedFav); }
      setTickForLineKey(key);
      updateLibCount(); updateFavCount(); updateOwnCount();
    } else {
      showNotice('You can add a maximum of ' + MAX_TOTAL + ' patterns.', 'Limit reached');
    }
  }
  function deselectOwnId(id){
    state.selectedOwnIds.delete(id);
    saveSelection(OWN_SEL_KEY, state.selectedOwnIds);
    setTickForOwnId(id);
    updateLibCount(); updateFavCount(); updateOwnCount();
  }
  function selectOwnId(id){
    if (state.mode === 'blitz') { maybeAutoReplaceIfBlitz(); }
    if (state.selectedOwnIds.has(id) || totalSelectedCount() < MAX_TOTAL){
      state.selectedOwnIds.add(id);
      saveSelection(OWN_SEL_KEY, state.selectedOwnIds);
      setTickForOwnId(id);
      updateLibCount(); updateFavCount(); updateOwnCount();
    } else {
      showNotice('You can add a maximum of ' + MAX_TOTAL + ' patterns.', 'Limit reached');
    }
  }

  const OWN_STORE_KEY = 'go:ownpatterns';
  function loadOwnPatterns(){ try { return JSON.parse(localStorage.getItem(OWN_STORE_KEY) || '[]'); } catch(_){ return []; } }
  function refreshOwnLookupFromLines(){
    state.keyToOwnIds = new Map();
    state.ownIdToKey = new Map();
    (state.linesOwn||[]).forEach(function(line){
      var id = line.__id; if (!id) return;
      var key = lineKey(line);
      state.ownIdToKey.set(id, key);
      if (!state.keyToOwnIds.has(key)) state.keyToOwnIds.set(key, new Set());
      state.keyToOwnIds.get(key).add(id);
    });
  }
  function rebuildOwnLookupIfNeeded(){
    if (state.keyToOwnIds && state.keyToOwnIds.size) return;
    state.keyToOwnIds = new Map();
    state.ownIdToKey  = new Map();
    try {
      const items = loadOwnPatterns().filter(p => Array.isArray(p?.moves) && p.moves.length >= MIN_MOVES);
      items.forEach(function(p){
        if (!p.id) return;
        const key = lineKey({ size: p.size || 19, moves: (p.moves||[]).map(m=>({x:m.x,y:m.y,color:m.color})) });
        state.ownIdToKey.set(p.id, key);
        if (!state.keyToOwnIds.has(key)) state.keyToOwnIds.set(key, new Set());
        state.keyToOwnIds.get(key).add(p.id);
      });
    } catch(_){}
  }

  function clearAllSelections(){
    state.selectedLib.clear();
    state.selectedFav.clear();
    state.selectedOwnIds.clear();
    saveSelection(LIB_SEL_KEY, state.selectedLib);
    saveSelection(FAV_SEL_KEY, state.selectedFav);
    saveSelection(OWN_SEL_KEY, state.selectedOwnIds);
    root.querySelectorAll('.joseki-card .tickbox[aria-checked="true"]').forEach(function(t){ t.setAttribute('aria-checked','false'); });
    updateLibCount(); updateFavCount(); updateOwnCount();
  }
  function clearKeysAcrossAll(keysIterable){
    var keys = Array.from(keysIterable || []); if (!keys.length) return;
    rebuildOwnLookupIfNeeded();
    var changedOwn = false;
    keys.forEach(function(k){
      state.selectedLib.delete(k);
      state.selectedFav.delete(k);
      setTickForLineKey(k);
      var idsSet = state.keyToOwnIds.get(k);
      if (idsSet){
        idsSet.forEach(function(id){
          if (state.selectedOwnIds.delete(id)){
            changedOwn = true;
            setTickForOwnId(id);
          }
        });
      }
    });
    saveSelection(LIB_SEL_KEY, state.selectedLib);
    saveSelection(FAV_SEL_KEY, state.selectedFav);
    if (changedOwn) saveSelection(OWN_SEL_KEY, state.selectedOwnIds);
    updateLibCount(); updateFavCount(); updateOwnCount();
  }

  function updateStartButton(){
    var n = totalSelectedCount();
    var shouldShow = overlayOpen && state.view !== 'mode' && n > 0 && n <= MAX_TOTAL;
    startBtn.style.display = shouldShow ? 'inline-block' : 'none';
    startBtn.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
    startBtn.disabled = !shouldShow;
  }
  function updateLibCount(){
    const n = totalSelectedCount();
    if (libCount) libCount.textContent = n + ' / ' + MAX_TOTAL + ' selected';
    updateStartButton();
  }

  function buildLibraryList(){
    state.selectedLib = loadSelection(LIB_SEL_KEY);
    libCatsGrid.innerHTML=''; libVarsGrid.innerHTML='';
    libVarsGrid.style.display='none'; libCatsGrid.style.display='grid';

    const loading=document.createElement('div');
    loading.className='s-card';
    loading.style.padding='12px';
    loading.innerHTML='<div class="info-title">Loading…</div><div class="info-desc">Reading joseki (10+ moves)…</div>';
    libCatsGrid.appendChild(loading);

    fetch(SGF_URL, { cache:'no-cache' })
      .then(r=>r.text())
      .then(txt=>{
        const trees=parseAllTrees(txt);
        const lines=[];
        for (const seq of trees){
          linkify(seq,null);
          const size=parseSZ(seq[0]?.SZ);
          const rootAB=listCoords(seq[0]?.AB, size);
          const rootAW=listCoords(seq[0]?.AW, size);
          const paths=enumerateLines(seq,size);
          for (const moves of paths){
            if ((moves?.length||0) >= MIN_MOVES){
              lines.push({ size, rootAB, rootAW, moves });
            }
          }
        }
        state.linesLib = lines;

        const catMap = new Map();
        for (let i=0;i<lines.length;i++){
          const mv = lines[i].moves; if (mv.length < 2) continue;
          const s = lines[i].size || 19, m1 = mv[0], m2 = mv[1];
          const key = `${s}|${m1.color}:${m1.x},${m1.y}|${m2.color}:${m2.x},${m2.y}`;
          if (!catMap.has(key)) catMap.set(key, { key, size:s, firstTwo:[m1,m2], lineIdx:[] });
          catMap.get(key).lineIdx.push(i);
        }
        state.libCats = Array.from(catMap.values());
        renderLibCategories();
        state.builtLib = true;
      })
      .catch(err=>{
        libCatsGrid.innerHTML='';
        const errEl=document.createElement('div');
        errEl.className='s-card';
        errEl.innerHTML='<div class="info-title">Could not load SGF</div><div class="info-desc">'+(err?.message||'Unknown error')+'</div>';
        libCatsGrid.appendChild(errEl);
      });
  }

  function renderLibCategories(){
    libCatsGrid.innerHTML='';
    libVarsGrid.style.display='none';
    libCatsGrid.style.display='grid';

    if (!state.libCats.length){
      const empty=document.createElement('div');
      empty.className='s-card';
      empty.innerHTML='<div class="info-title">No categories found</div><div class="info-desc">None with ≥ 10 moves.</div>';
      libCatsGrid.appendChild(empty); return;
    }

    state.libCats.forEach(cat=>{
      const card=document.createElement('button'); card.type='button'; card.className='s-card joseki-card'; card.dataset.key=cat.key;
      const thumb=document.createElement('div'); thumb.className='drill-thumb';
      const meta=document.createElement('div'); meta.className='joseki-meta';
      const title=document.createElement('div'); title.className='joseki-title';

      const count = cat.lineIdx.length;
      title.textContent = `${count} variation${count!==1?'s':''} (≥ ${MIN_MOVES} moves)`;

      meta.appendChild(title);
      card.appendChild(thumb); card.appendChild(meta);
      libCatsGrid.appendChild(card);

      renderTwoMoveThumb(thumb, cat.size||19, cat.firstTwo);
      card.addEventListener('click', function(){ showLibCategory(cat.key); });
    });
  }

  function renderLibVariations(catKey){
    libVarsGrid.innerHTML='';
    const cat = state.libCats.find(c=>c.key===catKey);
    if (!cat){ renderLibCategories(); return; }

    if (!cat.lineIdx.length){
      const empty=document.createElement('div');
      empty.className='s-card';
      empty.innerHTML='<div class="info-title">No josekis in this category</div><div class="info-desc">Try another category.</div>';
      libVarsGrid.appendChild(empty); return;
    }

    cat.lineIdx.forEach((idx,i)=>{
      const line = state.linesLib[idx];
      const key  = lineKey(line);

      const card=document.createElement('button'); card.type='button';
      card.className='s-card joseki-card'; card.dataset.key=key;

      const thumb=document.createElement('div'); thumb.className='drill-thumb';
      const meta=document.createElement('div'); meta.className='joseki-meta';
      const title=document.createElement('div'); title.className='joseki-title';
      const tick=document.createElement('span'); tick.className='tickbox'; tick.setAttribute('role','checkbox'); tick.setAttribute('tabindex','0');

      title.textContent = `Variation ${i+1} (${line.moves.length} moves)`;
      tick.setAttribute('aria-checked', isOnLineKey(key) ? 'true' : 'false');

      meta.appendChild(title);
      card.appendChild(thumb); card.appendChild(meta); card.appendChild(tick);
      libVarsGrid.appendChild(card);

      renderVariationThumb(thumb, line);

      function toggle(){
        const on = tick.getAttribute('aria-checked') === 'true';
        if (on){ deselectLineKeyGlobal(key); }
        else   { selectLineKeyIn('lib', key); }
      }
      card.addEventListener('click', toggle);
      tick.addEventListener('click', function(e){ e.stopPropagation(); toggle(); });
      tick.addEventListener('keydown', function(e){ if (e.key===' '||e.key==='Enter'){ e.preventDefault(); e.stopPropagation(); toggle(); }});
    });
  }

  const FAV_KEY = 'go_favorites';
  function readFavs(){
    try { return JSON.parse(localStorage.getItem(FAV_KEY) || '{}') || {}; } catch(_){ return {}; }
  }
  function updateFavCount(){
    const n = totalSelectedCount();
    if (favCount) favCount.textContent = n + ' / ' + MAX_TOTAL + ' selected';
    updateStartButton();
  }

  function buildFavoritesList(){
    state.selectedFav = loadSelection(FAV_SEL_KEY);
    favGrid.innerHTML='';
    const map = readFavs();
    const list = Object.values(map).filter(line => Array.isArray(line?.moves) && line.moves.length >= MIN_MOVES);

    if (!list.length){
      const empty=document.createElement('div');
      empty.className='s-card';
      empty.innerHTML='<div class="info-title">No favorites yet</div><div class="info-desc">Star josekis in Practice to see them here (10+ moves).</div>';
      favGrid.appendChild(empty);
      state.linesFav = []; state.builtFav = true; updateFavCount(); return;
    }

    state.linesFav = list.map(l => ({
      size: l.size || 19,
      rootAB: Array.isArray(l.rootAB)?l.rootAB:[],
      rootAW: Array.isArray(l.rootAW)?l.rootAW:[],
      moves:  (l.moves||[]).map(m => ({x:m.x,y:m.y,color:m.color}))
    }));

    renderFavGrid(); state.builtFav = true;
  }

  function renderFavGrid(){
    favGrid.innerHTML='';
    if (!state.linesFav.length){
      const empty=document.createElement('div');
      empty.className='s-card';
      empty.innerHTML='<div class="info-title">No favorites available</div><div class="info-desc">None meet the 10+ move rule.</div>';
      favGrid.appendChild(empty); updateFavCount(); return;
    }

    state.linesFav.forEach((line, i)=>{
      const key = lineKey(line);
      const card=document.createElement('button'); card.type='button';
      card.className='s-card joseki-card'; card.dataset.key=key;

      const thumb=document.createElement('div'); thumb.className='drill-thumb';
      const meta=document.createElement('div'); meta.className='joseki-meta';
      const title=document.createElement('div'); title.className='joseki-title';
      const tick=document.createElement('span'); tick.className='tickbox'; tick.setAttribute('role','checkbox'); tick.setAttribute('tabindex','0');

      title.textContent = `Favorite ${i+1} (${line.moves.length} moves)`;
      tick.setAttribute('aria-checked', isOnLineKey(key) ? 'true' : 'false');

      meta.appendChild(title);
      card.appendChild(thumb); card.appendChild(meta); card.appendChild(tick);
      favGrid.appendChild(card);

      renderVariationThumb(thumb, line);

      function toggle(){
        const on = tick.getAttribute('aria-checked') === 'true';
        if (on){ deselectLineKeyGlobal(key); }
        else   { selectLineKeyIn('fav', key); }
      }
      card.addEventListener('click', toggle);
      tick.addEventListener('click', function(e){ e.stopPropagation(); toggle(); });
      tick.addEventListener('keydown', function(e){ if (e.key===' '||e.key==='Enter'){ e.preventDefault(); e.stopPropagation(); toggle(); }});
    });
    updateFavCount();
  }

  function updateOwnCount(){
    const n = totalSelectedCount();
    if (ownCount) ownCount.textContent = n + ' / ' + MAX_TOTAL + ' selected';
    updateStartButton();
  }

  function buildOwnList(){
    state.selectedOwnIds = loadSelection(OWN_SEL_KEY);
    ownGrid.innerHTML='';

    const items = loadOwnPatterns().filter(p => Array.isArray(p?.moves) && p.moves.length >= MIN_MOVES);

    if (!items.length){
      const empty=document.createElement('div');
      empty.className='s-card';
      empty.innerHTML='<div class="info-title">No eligible patterns</div><div class="info-desc">Add patterns in “My Patterns” with at least 10 moves to use them here.</div>';
      ownGrid.appendChild(empty);
      state.linesOwn = []; state.builtOwn = true; updateOwnCount(); return;
    }

    state.linesOwn = items.map(p => ({
      __id: p.id || ('own-'+Math.random().toString(36).slice(2)),
      title: p.title || 'My Pattern',
      size: p.size || 19,
      rootAB: Array.isArray(p.rootAB) ? p.rootAB : [],
      rootAW: Array.isArray(p.rootAW) ? p.rootAW : [],
      moves: (p.moves||[]).map(m => ({ x:m.x, y:m.y, color:m.color }))
    }));

    refreshOwnLookupFromLines();
    renderOwnGrid(); state.builtOwn = true;
  }

  function renderOwnGrid(){
    ownGrid.innerHTML='';
    if (!state.linesOwn.length){
      const empty=document.createElement('div');
      empty.className='s-card';
      empty.innerHTML='<div class="info-title">No patterns available</div><div class="info-desc">None meet the 10+ move rule.</div>';
      ownGrid.appendChild(empty); updateOwnCount(); return;
    }

    state.linesOwn.forEach((line, i)=>{
      const id   = line.__id;
      const key  = lineKey(line);

      const card=document.createElement('button'); card.type='button';
      card.className='s-card joseki-card'; card.dataset.ownId=id; card.dataset.key=key;

      const thumb=document.createElement('div'); thumb.className='drill-thumb';
      const meta=document.createElement('div'); meta.className='joseki-meta';
      const title=document.createElement('div'); title.className='joseki-title';
      const tick=document.createElement('span'); tick.className='tickbox'; tick.setAttribute('role','checkbox'); tick.setAttribute('tabindex','0');

      title.textContent = `Pattern ${i+1}: ${line.moves.length} Moves`;
      tick.setAttribute('aria-checked', state.selectedOwnIds.has(id) ? 'true' : 'false');

      meta.appendChild(title);
      card.appendChild(thumb); card.appendChild(meta); card.appendChild(tick);
      ownGrid.appendChild(card);

      renderVariationThumb(thumb, line);

      function toggle(){
        const on = tick.getAttribute('aria-checked') === 'true';
        if (on){ deselectOwnId(id); }
        else   { selectOwnId(id); }
      }
      card.addEventListener('click', toggle);
      tick.addEventListener('click', function(e){ e.stopPropagation(); toggle(); });
      tick.addEventListener('keydown', function(e){ if (e.key===' '||e.key==='Enter'){ e.preventDefault(); e.stopPropagation(); toggle(); }});
    });
    updateOwnCount();
  }

  libClear && libClear.addEventListener('click', clearAllSelections);
  favClear && favClear.addEventListener('click', clearAllSelections);
  ownClear && ownClear.addEventListener('click', clearAllSelections);

  window.addEventListener('storage', function(e){
    if (e.key === 'go:ownpatterns' && state.view === 'own') buildOwnList();
    if (e.key === 'go_favorites'  && state.view === 'fav') buildFavoritesList();
  });

  function startDrillNow(){
    try{
      if (window.GoDrills && typeof window.GoDrills.close === 'function') GoDrills.close();
      var cap = document.getElementById('drill-cap'); if (cap) cap.style.display='none';
      if (window.DrillBoard && typeof window.DrillBoard.load === 'function'){
        DrillBoard.load(null, { perJoseki: 3 });
      }
    }catch(_){}
  }
  function captureProStart(e){
    if (!isPro()) return;
    if (state.mode !== 'complete') return;
    if (!e) return;
    e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation();
    startDrillNow();
  }
  function captureProRetry(e){
    if (!isPro()) return;
    if (state.mode !== 'complete') return;
    var btn = e && e.target && e.target.closest ? e.target.closest('#drill-done-retry') : null;
    if (!btn) return;
    e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation();
    try{ var done = document.getElementById('drill-done'); if (done) done.style.display='none'; }catch(_){}
    startDrillNow();
  }
  document.addEventListener('click', function(e){
    var start = e.target && e.target.closest ? e.target.closest('#drills-start') : null;
    if (start) captureProStart(e);
  }, true);
  document.addEventListener('pointerup', function(e){
    var start = e.target && e.target.closest ? e.target.closest('#drills-start') : null;
    if (start) captureProStart(e);
  }, true);
  document.addEventListener('touchend', function(e){
    var start = e.target && e.target.closest ? e.target.closest('#drills-start') : null;
    if (start) captureProStart(e);
  }, { capture:true, passive:false });

  document.addEventListener('click', captureProRetry, true);
  document.addEventListener('pointerup', captureProRetry, true);
  document.addEventListener('touchend', captureProRetry, { capture:true, passive:false });

  function autoHideCapIfPro(){
    if (!isPro()) return;
    var cap = document.getElementById('drill-cap');
    if (cap && cap.style.display !== 'none') cap.style.display='none';
  }
  setInterval(autoHideCapIfPro, 800);

  // default mode and auto-open on page load
  setMode('complete');
  open();
})();
</script>
</body>
</html>
