<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Practice Board (Minimal)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin:0; padding:0; height:100%;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    body { position:relative; background:#222; color:#eee; }

    #go-board-prac-wrap {
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:100%; max-width:720px;
      box-sizing:border-box;
    }
    #go-board-prac { width:100%; border-radius:8px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,.5); }
  </style>

  <script src="../lib/wgo.min.js"></script>
</head>
<body>

<div id="go-board-prac-wrap">
  <div id="go-board-prac"></div>
</div>

<script>
(function(){
  if (!window.WGo) return setTimeout(arguments.callee, 50);

  const mount = document.getElementById("go-board-prac");
  const SIZE = 19, B = "B", W = "W";
  const board = new WGo.Board(mount, { size: SIZE });
  const grid = Array.from({length:SIZE},()=>Array(SIZE).fill(null));
  let turn = B, lastX = null, lastY = null;

  const prefs = JSON.parse(localStorage.getItem("go_prefs")||"{}");
  const highlightLast = prefs.highlightLast ?? true;
  const soundOn = prefs.soundOn ?? true;
  const zoomOn = prefs.josekiZoom ?? true;
  const playSpeed = prefs.autoPlaySpeed ?? "fast";

  // --- Stone SFX ---
  function playStoneSound(){
    if (!soundOn) return;
    const a = new Audio("../sound/click.mp3");
    a.volume = .3;
    a.play().catch(()=>{});
  }

  // --- Redraw board ---
  function redraw(){
    board.removeAllObjects();
    for (let y=0;y<SIZE;y++){
      for (let x=0;x<SIZE;x++){
        const v = grid[y][x];
        if (v===B) board.addObject({x,y,c:WGo.B});
        else if (v===W) board.addObject({x,y,c:WGo.W});
      }
    }
    if (highlightLast && lastX!=null && lastY!=null)
      board.addObject({x:lastX,y:lastY,type:"CR"});
  }

  // --- Simple placement ---
  board.addEventListener("click", (x,y)=>{
    if (grid[y][x]) return;
    grid[y][x]=turn;
    lastX=x; lastY=y;
    playStoneSound();
    redraw();
    turn = (turn===B?W:B);
  });

  // --- Basic Zoom (identical to main board logic) ---
  let scale=1, offsetX=0, offsetY=0, isFullscreen=false, baseW=0, overlay=null, zoomLayer=null;
  const minScale=1, maxScale=2.6;

  function getXcss(i){return board.getX(i);}
  function getYcss(j){return board.getY(j);}

  function ensureZoomLayer(){
    if (zoomLayer) return;
    mount.style.position="relative";
    zoomLayer=document.createElement("div");
    zoomLayer.style.position="absolute";
    zoomLayer.style.left="0";zoomLayer.style.top="0";
    zoomLayer.style.transformOrigin="0 0";
    zoomLayer.style.willChange="transform";
    while(mount.firstChild) zoomLayer.appendChild(mount.firstChild);
    mount.appendChild(zoomLayer);
  }
  ensureZoomLayer();

  function applyPanAndSize(){
    zoomLayer.style.transform=`translate(${-offsetX}px,${-offsetY}px) scale(${scale})`;
  }

  function centerZoomAtGrid(i,j,factor){
    const targetScale=Math.max(minScale,Math.min(maxScale,scale*factor));
    const px=getXcss(i), py=getYcss(j);
    const rect=mount.getBoundingClientRect();
    const sx=rect.width/2, sy=rect.height/2;
    scale=targetScale;
    offsetX=px - sx/scale;
    offsetY=py - sy/scale;
    applyPanAndSize();
  }

  mount.addEventListener("click", e=>{
    if (!zoomOn) return;
    if (!isFullscreen){ // enter zoom
      const rect=mount.getBoundingClientRect();
      const sx=e.clientX-rect.left, sy=e.clientY-rect.top;
      let bestI=0,bestJ=0,bestD=1e9;
      for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
        const dx=getXcss(i)-sx, dy=getYcss(j)-sy, d=dx*dx+dy*dy;
        if(d<bestD){bestD=d;bestI=i;bestJ=j;}
      }
      document.body.style.overflow="hidden";
      isFullscreen=true;
      baseW=Math.floor(Math.min(window.innerWidth,window.innerHeight));
      mount.style.width="100vw";mount.style.height="100vh";
      centerZoomAtGrid(bestI,bestJ,2.3);
    } else { // exit zoom
      scale=1;offsetX=0;offsetY=0;
      applyPanAndSize();
      isFullscreen=false;
      document.body.style.overflow="";
      mount.style.width="";mount.style.height="";
    }
  });

  redraw();
})();
</script>
</body>
</html>
